# Directories
SRC_DIR = ../src
SIM_DIR = ../sim
VSIMOPT = -vopt -voptargs=+acc 

# Files for Register
 VERILOG_FILES = $(SRC_DIR)/register.sv $(SRC_DIR)/register_tb.sv $(SRC_DIR)/gpio_defines.sv
 TOP_MODULE = register_tb

# Files for aux_if
# VERILOG_FILES = $(SRC_DIR)/aux_if.sv $(SRC_DIR)/aux_reg.sv $(SRC_DIR)/aux_if_tb.sv
# TOP_MODULE = aux_if_tb

# Files for apb_interface
 #VERILOG_FILES = $(SRC_DIR)/apb_if.sv $(SRC_DIR)/apb_if_tb.sv $(SRC_DIR)/apb_fsm.sv 
 #TOP_MODULE = apb_if_tb

# Files for io_interface
# VERILOG_FILES = $(SRC_DIR)/apb_io.sv $(SRC_DIR)/apb_io_tb.sv
# TOP_MODULE = apb_io_tb

# Files for apb_top
#VERILOG_FILES = $(SRC_DIR)/*.sv
#TOP_MODULE = apb_top_tb

# Coverage database and report directory
COV_DB = $(SIM_DIR)/covdb.ucdb
COV_REPORT_DIR = $(SIM_DIR)/covhtmlreport

# Simulation using QuestaSim with coverage
simulate:
	mkdir -p ../quartus
	mkdir -p $(SIM_DIR)
	vlib $(SIM_DIR)
	vlog -work $(SIM_DIR) -coveropt 3 +cover $(VERILOG_FILES)
	vsim $(VSIMOPT) -coverage -c -do "coverage save -onexit -codeAll $(COV_DB); log -r /* ;run -all; quit" $(TOP_MODULE) -work $(SIM_DIR) -l $(SIM_DIR)/simulation.log -wlf $(SIM_DIR)/waveform.wlf

# Simulation in GUI mode with coverage
simulate_gui:
	mkdir -p $(SIM_DIR)
	vlib $(SIM_DIR)
	vlog -work $(SIM_DIR) -coveropt 3 +cover $(VERILOG_FILES)
	vsim $(VSIMOPT) -coverage -do "log -r /*" $(TOP_MODULE) -work $(SIM_DIR)

# View waveform
view_wave_Questa:
	vsim -view $(SIM_DIR)/waveform.wlf

# Generate coverage report
cov_report:
	vcover report -details -codeAll -html -output $(COV_REPORT_DIR) $(COV_DB)

# View coverage report in browser
view_cov_report:
	firefox $(COV_REPORT_DIR)/index.html &

# Help
help:
	@echo "=================================== HELP ===================================="
	@echo "Makefile Commands:"
	@echo ""
	@echo "  simulate          : Run the simulation using QuestaSim with coverage and save waveform/log."
	@echo "  simulate_gui      : Run the simulation in QuestaSim GUI mode with coverage for interactive debugging."
	@echo "  view_wave_Questa  : View the waveform generated by QuestaSim."
	@echo "  cov_report        : Generate HTML coverage report from the coverage database."
	@echo "  view_cov_report   : Open the HTML coverage report in Firefox."
	@echo "  clean             : Remove all generated files and clean the workspace."
	@echo ""
	@echo "Example Usage:"
	@echo "  make simulate          # To run the simulation with coverage in QuestaSim."
	@echo "  make simulate_gui      # To run the simulation with coverage in QuestaSim GUI mode."
	@echo "  make view_wave_Questa  # To view the waveform from QuestaSim."
	@echo "  make cov_report        # To generate the coverage report."
	@echo "  make view_cov_report   # To view the coverage report in Firefox."
	@echo "  make clean             # To clean all generated files."
	@echo "============================================================================"

# Clean command
clean:
	rm -rf $(SIM_DIR)
